
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>LSTM降雨径流建模 &#8212; iHeadWater Hackweek Tutorials</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="使用VSCode编写运行代码" href="chp8.2_run_in_vscode.html" />
    <link rel="prev" title="使用CAMELS数据集构建基于LSTM的降雨径流模型" href="chp8.0_intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">iHeadWater Hackweek Tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    欢迎来到水资源科研编程入门教程
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../start_from_here.html">
   从这里开始
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp1_open_science_workflow/chp1.0_intro.html">
   编程概念及相关工具
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.1.1_workflow.html">
     可复现科研的一般工作流程
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.1.2_tools.html">
     常用工具
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.2.1_bash.html">
     Bash 简介以及在命令行中操作文件和目录
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.2.2_common.html">
     管理目录和文件的Bash命令
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.3_git.html">
     关于Git和GitHub
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp1_open_science_workflow/chp1.4_jupyter.html">
     Jupyter Hub/Lab/Notebook 简介
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp2_file_formats/chp2.0_intro.html">
   常见的数据文件格式
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp2_file_formats/chp2.1_txt_csv.html">
     文本类数据
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp2_file_formats/chp2.2_vector_data.html">
     地理空间数据–矢量
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp2_file_formats/chp2.3_raster_data.html">
     地理空间数据–栅格
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp2_file_formats/chp2.4_your_data.html">
     在平台上上传下载数据
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp3_version_control/chp3.0_introduction.html">
   使用版本控制工具
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp3_version_control/chp3.1_get_files_from_github.html">
     从Github获取文件
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp3_version_control/chp3.2_setup_git.html">
     配置Git
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp3_version_control/chp3.3_git_setup_and_commands.html">
     使用Git命令进行版本控制
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp3_version_control/chp3.4_team_work.html">
     在GitHub上协作工作
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp4_intro_to_python/chp4.0_intro.html">
   Python编程基础
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.1_about_python.html">
     Python编程语言简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.2_python_variables.html">
     Python 中的变量
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.3_list_dict_tuble_set.html">
     常用数据结构
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.4_python_operators.html">
     基本运算符
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.5_conditional_statements.html">
     条件语句
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.6_loops.html">
     循环
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp4_intro_to_python/chp4.7_functions.html">
     函数
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp5_python_data_science/chp5.0_intro.html">
   Python 数据分析常用工具包
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp5_python_data_science/chp5.1_numpy.html">
     Numpy 简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp5_python_data_science/chp5.2_pandas.html">
     Pandas 简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp5_python_data_science/chp5.3_matplotlib.html">
     matplotlib简介
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp6_deep_learning_review/chp6.0_intro.html">
   深度学习简介
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp6_deep_learning_review/chp6.1_common_nn.html">
     深度学习常见算法及模型的简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp6_deep_learning_review/chp6.2_hydro.html">
     深度学习在水文领域中的应用研究
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../chp7_intro_to_pytorch/chp7.0_intro.html">
   初探PyTorch
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp7_intro_to_pytorch/chp7.1_tensor.html">
     PyTorch中的Tensor基础
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp7_intro_to_pytorch/chp7.2_neural_network.html">
     torch.nn简介
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../chp7_intro_to_pytorch/chp7.3_dataloader.html">
     Dataset和DataLoader简介
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="chp8.0_intro.html">
   使用CAMELS数据集构建基于LSTM的降雨径流模型
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     LSTM降雨径流建模
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="chp8.2_run_in_vscode.html">
     使用VSCode编写运行代码
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tldr.html">
   TLDR页
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../citations.html">
   参考资料
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/iHeadWater/iheadwater_hackweek_tutorials/main?urlpath=tree/docs/chp8_lstm_camels/chp8.1_run_in_jupyter.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/iHeadWater/iheadwater_hackweek_tutorials"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/iHeadWater/iheadwater_hackweek_tutorials/issues/new?title=Issue%20on%20page%20%2Fchp8_lstm_camels/chp8.1_run_in_jupyter.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chp8_lstm_camels/chp8.1_run_in_jupyter.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lstm-camels">
   1 LSTM-CAMELS简介
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#camels">
   2 获取CAMELS数据
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pytorchlstm-camels">
   3 PyTorch实现LSTM-CAMELS
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pytorch-datasetdataloadercamels">
     3.1 用PyTorch Dataset与Dataloader组织CAMELS数据
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     3.2 搭建LSTM模型
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   4 训练模型
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   5 评价模型
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>LSTM降雨径流建模</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lstm-camels">
   1 LSTM-CAMELS简介
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#camels">
   2 获取CAMELS数据
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pytorchlstm-camels">
   3 PyTorch实现LSTM-CAMELS
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pytorch-datasetdataloadercamels">
     3.1 用PyTorch Dataset与Dataloader组织CAMELS数据
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     3.2 搭建LSTM模型
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   4 训练模型
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   5 评价模型
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="lstm">
<h1>LSTM降雨径流建模<a class="headerlink" href="#lstm" title="Permalink to this headline">#</a></h1>
<p>本节给出一个关于如何建立和训练LSTM-CAMELS模型的例子。如果你使用了平台提供的jupyterlab，那就能直接使用平台上的GPU计算资源来完成相应的计算。因为我们会有一些人同时运行代码，所以为了避免机器资源不够，以及快速地交互给出结果，这里只给出了少量流域上训练测试模型的示例，更多流域的完整复现Kratzert等<span id="id1">[<a class="reference internal" href="../citations.html#id7" title="F. Kratzert, D. Klotz, C. Brenner, K. Schulz, and M. Herrnegger. Rainfall–runoff modelling using long short-term memory (lstm) networks. Hydrology and Earth System Sciences, 22(11):6005–6022, 2018. URL: https://hess.copernicus.org/articles/22/6005/2018/, doi:10.5194/hess-22-6005-2018.">KKB+18</a>]</span>论文的例子也是一样的，大家可以自行尝试。</p>
<section id="lstm-camels">
<h2>1 LSTM-CAMELS简介<a class="headerlink" href="#lstm-camels" title="Permalink to this headline">#</a></h2>
<p>首先，我们简单看看模型输入输出以及模型结构，如下图所示，左边是数据集数据情况，右边是模型的基本结构，中间深蓝色箭头表示哪些数据以什么形式送入模型中。</p>
<p>CAMELS数据集包含的流域层面数据有径流数据、流域平均的气象时间序列数据和流域平均的气候地理属性数据；</p>
<p>其中，属性数据也能为建模提供帮助（可以参考Kratzert等另一篇文章 <span id="id2">[<a class="reference internal" href="../citations.html#id8" title="F. Kratzert, D. Klotz, G. Shalev, G. Klambauer, S. Hochreiter, and G. Nearing. Towards learning universal, regional, and local hydrological behaviors via machine learning applied to large-sample datasets. Hydrology and Earth System Sciences, 23(12):5089–5110, 2019. URL: https://hess.copernicus.org/articles/23/5089/2019/, doi:10.5194/hess-23-5089-2019.">KKS+19</a>]</span>），因为LSTM接受的是时序输入，所以需要把它们复制到每个时段和其他时序输入拼接在一起后送入LSTM模型；径流数据就在训练中用于和模型输出比较计算损失函数值。</p>
<p>LSTM模型前面已经有介绍过基本原理了，这里简单介绍Kratzert等<span id="id3">[<a class="reference internal" href="../citations.html#id7" title="F. Kratzert, D. Klotz, C. Brenner, K. Schulz, and M. Herrnegger. Rainfall–runoff modelling using long short-term memory (lstm) networks. Hydrology and Earth System Sciences, 22(11):6005–6022, 2018. URL: https://hess.copernicus.org/articles/22/6005/2018/, doi:10.5194/hess-22-6005-2018.">KKB+18</a>]</span>论文中的模型，也就是图中所示的结构。</p>
<p>论文中模型由两层LSTM堆叠而成，LSTM最后一个时段的输出会进入到一个线性层（Dense Layer），输出一个神经元值，它就是预测的径流。输出的虚线部分意思是每个时段均有LSTM隐含层输出，只是这里我们只用了最后一个时段的输出。</p>
<p><img alt="" src="../_images/LSTM-CAMELS.png" /></p>
</section>
<section id="camels">
<h2>2 获取CAMELS数据<a class="headerlink" href="#camels" title="Permalink to this headline">#</a></h2>
<p>在开始正式实现LSTM-CAMELS之前，我们需要先获取CAMELS数据，为了方便大家使用CAMELS数据，我们已经将数据下载到平台服务器了，并且打包了读取CAMELS数据的代码，还将其内置在目前的python环境下了，所以我们现在直接写一些简单的调用代码就能读取CAMELS数据了。</p>
<p>因为我们的包还不知道下载的CAMELS数据集在哪，所以开始前需要设置一个配置文件，运行以下代码即可：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hydrodataset</span>
</pre></div>
</div>
</div>
</div>
<p>前面<a class="reference external" href="https://iheadwater.github.io/iheadwater_hackweek_tutorials/chp2_file_formats/chp2.3_raster_data.html#netcdf">第二章中</a>已经配置过数据目录了，这里就不再重复，如果没有配置的，还需要按照其中的指示配置好。</p>
<p>接下来我们就可以试试读取CAMELS数据集了</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">hydrodataset.camels</span> <span class="kn">import</span> <span class="n">Camels</span>

<span class="n">camels_us_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;camels&quot;</span><span class="p">,</span> <span class="s2">&quot;camels_us&quot;</span><span class="p">)</span>
<span class="n">us_region</span> <span class="o">=</span> <span class="s2">&quot;US&quot;</span>
<span class="n">camels_us</span> <span class="o">=</span> <span class="n">Camels</span><span class="p">(</span><span class="n">camels_us_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">us_region</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">camels_us_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;camels&quot;</span><span class="p">,</span> <span class="s2">&quot;camels_us&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">us_region</span> <span class="o">=</span> <span class="s2">&quot;US&quot;</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">camels_us</span> <span class="o">=</span> <span class="n">Camels</span><span class="p">(</span><span class="n">camels_us_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">us_region</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/hydrodataset/camels.py:93,</span> in <span class="ni">Camels.__init__</span><span class="nt">(self, data_path, download, region)</span>
<span class="g g-Whitespace">     </span><span class="mi">91</span> <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span>     <span class="bp">self</span><span class="o">.</span><span class="n">download_data_source</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">93</span> <span class="bp">self</span><span class="o">.</span><span class="n">camels_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_site_info</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/hydrodataset/camels.py:427,</span> in <span class="ni">Camels.read_site_info</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span> <span class="n">camels_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_description</span><span class="p">[</span><span class="s2">&quot;CAMELS_GAUGE_FILE&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">427</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span>         <span class="n">camels_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gauge_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;huc_02&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span> <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;AUS&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">camels_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;station_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/util/_decorators.py:211,</span> in <span class="ni">deprecate_kwarg.&lt;locals&gt;._deprecate_kwarg.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>         <span class="n">kwargs</span><span class="p">[</span><span class="n">new_arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_arg_value</span>
<span class="ne">--&gt; </span><span class="mi">211</span> <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/util/_decorators.py:317,</span> in <span class="ni">deprecate_nonkeyword_arguments.&lt;locals&gt;.decorate.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_allow_args</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span>     <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>         <span class="ne">FutureWarning</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">315</span>         <span class="n">stacklevel</span><span class="o">=</span><span class="n">find_stack_level</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()),</span>
<span class="g g-Whitespace">    </span><span class="mi">316</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">317</span> <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/io/parsers/readers.py:950,</span> in <span class="ni">read_csv</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, squeeze, prefix, mangle_dupe_cols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, error_bad_lines, warn_bad_lines, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">935</span> <span class="n">kwds_defaults</span> <span class="o">=</span> <span class="n">_refine_defaults_read</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">936</span>     <span class="n">dialect</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">937</span>     <span class="n">delimiter</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">946</span>     <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;delimiter&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="p">},</span>
<span class="g g-Whitespace">    </span><span class="mi">947</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">948</span> <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds_defaults</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">950</span> <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/io/parsers/readers.py:605,</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">602</span> <span class="n">_validate_names</span><span class="p">(</span><span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">604</span> <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">605</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">607</span> <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">608</span>     <span class="k">return</span> <span class="n">parser</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/io/parsers/readers.py:1442,</span> in <span class="ni">TextFileReader.__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1439</span>     <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1441</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">IOHandles</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">-&gt; </span><span class="mi">1442</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/io/parsers/readers.py:1729,</span> in <span class="ni">TextFileReader._make_engine</span><span class="nt">(self, f, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1727</span>     <span class="n">is_text</span> <span class="o">=</span> <span class="kc">False</span>
<span class="g g-Whitespace">   </span><span class="mi">1728</span>     <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;rb&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1729</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="o">=</span> <span class="n">get_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1730</span>     <span class="n">f</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1731</span>     <span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1732</span>     <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1733</span>     <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1734</span>     <span class="n">memory_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_map&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1735</span>     <span class="n">is_text</span><span class="o">=</span><span class="n">is_text</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1736</span>     <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding_errors&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1737</span>     <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;storage_options&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1738</span> <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1739</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1740</span> <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="o">.</span><span class="n">handle</span>

<span class="nn">File /usr/share/miniconda/envs/tutorial/lib/python3.8/site-packages/pandas/io/common.py:857,</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">852</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">853</span>     <span class="c1"># Check whether the filename is to be opened in binary mode.</span>
<span class="g g-Whitespace">    </span><span class="mi">854</span>     <span class="c1"># Binary mode does not support &#39;encoding&#39; and &#39;newline&#39;.</span>
<span class="g g-Whitespace">    </span><span class="mi">855</span>     <span class="k">if</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">and</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">856</span>         <span class="c1"># Encoding</span>
<span class="ne">--&gt; </span><span class="mi">857</span>         <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">858</span>             <span class="n">handle</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>             <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span>             <span class="n">encoding</span><span class="o">=</span><span class="n">ioargs</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">861</span>             <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">862</span>             <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">863</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">864</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">865</span>         <span class="c1"># Binary mode</span>
<span class="g g-Whitespace">    </span><span class="mi">866</span>         <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/home/runner/.hydrodataset/cache/camels/camels_us/camels_name.txt&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">camels_us</span><span class="o">.</span><span class="n">camels_sites</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gauge_id</th>
      <th>huc_02</th>
      <th>gauge_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01013500</td>
      <td>01</td>
      <td>Fish River near Fort Kent, Maine</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01022500</td>
      <td>01</td>
      <td>Narraguagus River at Cherryfield, Maine</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01030500</td>
      <td>01</td>
      <td>Mattawamkeag River near Mattawamkeag, Maine</td>
    </tr>
    <tr>
      <th>3</th>
      <td>01031500</td>
      <td>01</td>
      <td>Piscataquis River near Dover-Foxcroft, Maine</td>
    </tr>
    <tr>
      <th>4</th>
      <td>01047000</td>
      <td>01</td>
      <td>Carrabassett River near North Anson, Maine</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>因为CAMELS文件都是txt格式，每次都直接读取txt速度会比较慢，所以我们提供了存数据到能快速读取的二进制数据格式文件的方法。</p>
<p>这一步我们已经提前做好了，数据文件在前面用到的frproot下的camels/camels_us文件夹下了，所以这里我们直接使用它。</p>
<p>径流和气象数据文件是netcdf（简称nc）格式，使用n格式的原因是：如果把所有变量一次都读进内存，数据量还是有点大，所以这里我们使用一个名叫xarray的包来读取nc文件，这样我们就能懒加载数据了，即不必一次性把所有数据加载到内存中，而是在使用到哪一部分数据时，再把那一部分数据加载进来。虽然本节后续示例中我们实际上没用多少流域，但是这里还是推荐这种方式，以后做深度学习应用研究，这应是一种比较常见的方式。</p>
<p>属性数据是feather格式，也是一种读写比较快的文件类型，用pandas即可打开。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">camels_us</span><span class="o">.</span><span class="n">data_source_dir</span>
<span class="n">data_dir</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PosixPath(&#39;/ftproot/camels/camels_us&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">hydrodataset</span><span class="o">.</span><span class="n">CACHE_DIR</span>
<span class="n">cache_dir</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PosixPath(&#39;/home/ouyangwenyu/.hydrodataset/cache&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streamflow_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;camels_streamflow.nc&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streamflow_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:     (basin: 671, time: 12784)
Coordinates:
  * basin       (basin) object &#x27;01013500&#x27; &#x27;01022500&#x27; ... &#x27;14362250&#x27; &#x27;14400000&#x27;
  * time        (time) datetime64[ns] 1980-01-01 1980-01-02 ... 2014-12-31
Data variables:
    streamflow  (basin, time) float64 ...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-6cc455df-c14e-46d7-a909-825e52302fce' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-6cc455df-c14e-46d7-a909-825e52302fce' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>basin</span>: 671</li><li><span class='xr-has-index'>time</span>: 12784</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-6d020cc4-ab56-4e15-aa5f-d92096f71e15' class='xr-section-summary-in' type='checkbox'  checked><label for='section-6d020cc4-ab56-4e15-aa5f-d92096f71e15' class='xr-section-summary' >Coordinates: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>basin</span></div><div class='xr-var-dims'>(basin)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;01013500&#x27; ... &#x27;14400000&#x27;</div><input id='attrs-b7ac561a-288a-4ad1-97c0-f446cc5269e7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-b7ac561a-288a-4ad1-97c0-f446cc5269e7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-fcf98824-97f3-4a8f-a6d4-09236a6445b7' class='xr-var-data-in' type='checkbox'><label for='data-fcf98824-97f3-4a8f-a6d4-09236a6445b7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;01013500&#x27;, &#x27;01022500&#x27;, &#x27;01030500&#x27;, ..., &#x27;14325000&#x27;, &#x27;14362250&#x27;,
       &#x27;14400000&#x27;], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1980-01-01 ... 2014-12-31</div><input id='attrs-04b436b9-7574-4dba-a7c8-f9ce72c33bdd' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-04b436b9-7574-4dba-a7c8-f9ce72c33bdd' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b0828d0f-3dbf-42ea-9ab5-60e7f59d4bf2' class='xr-var-data-in' type='checkbox'><label for='data-b0828d0f-3dbf-42ea-9ab5-60e7f59d4bf2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;1980-01-01T00:00:00.000000000&#x27;, &#x27;1980-01-02T00:00:00.000000000&#x27;,
       &#x27;1980-01-03T00:00:00.000000000&#x27;, ..., &#x27;2014-12-29T00:00:00.000000000&#x27;,
       &#x27;2014-12-30T00:00:00.000000000&#x27;, &#x27;2014-12-31T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-6f9c64d0-f1bf-488d-bd38-6f6bd0092539' class='xr-section-summary-in' type='checkbox'  checked><label for='section-6f9c64d0-f1bf-488d-bd38-6f6bd0092539' class='xr-section-summary' >Data variables: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>streamflow</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-00b4aa24-919e-4e54-aef4-04de40bc9663' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-00b4aa24-919e-4e54-aef4-04de40bc9663' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-fd88d90f-985f-422d-8397-947770da94b4' class='xr-var-data-in' type='checkbox'><label for='data-fd88d90f-985f-422d-8397-947770da94b4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>cfs</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-67e04d71-50b6-4e11-ab85-db01ccb834d3' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-67e04d71-50b6-4e11-ab85-db01ccb834d3' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streamflow_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">basin</span><span class="o">=</span><span class="s2">&quot;01013500&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;2000-06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2001-05-31&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;time&#39;&gt;
</pre></div>
</div>
<img alt="../_images/chp8.1_run_in_jupyter_15_1.png" src="../_images/chp8.1_run_in_jupyter_15_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forcing_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;camels_daymet_forcing.nc&quot;</span><span class="p">))</span>
<span class="n">forcing_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:  (basin: 671, time: 12784)
Coordinates:
  * basin    (basin) object &#x27;01013500&#x27; &#x27;01022500&#x27; ... &#x27;14362250&#x27; &#x27;14400000&#x27;
  * time     (time) datetime64[ns] 1980-01-01 1980-01-02 ... 2014-12-31
Data variables:
    dayl     (basin, time) float64 ...
    prcp     (basin, time) float64 ...
    srad     (basin, time) float64 ...
    swe      (basin, time) float64 ...
    tmax     (basin, time) float64 ...
    tmin     (basin, time) float64 ...
    vp       (basin, time) float64 ...
Attributes:
    forcing_type:  daymet</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-d0ccc427-94eb-48c2-b4cc-004cb64e82a8' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-d0ccc427-94eb-48c2-b4cc-004cb64e82a8' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>basin</span>: 671</li><li><span class='xr-has-index'>time</span>: 12784</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-5a8b9540-31d5-41b9-b676-65b79c5b8708' class='xr-section-summary-in' type='checkbox'  checked><label for='section-5a8b9540-31d5-41b9-b676-65b79c5b8708' class='xr-section-summary' >Coordinates: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>basin</span></div><div class='xr-var-dims'>(basin)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;01013500&#x27; ... &#x27;14400000&#x27;</div><input id='attrs-449f50f4-63ae-43e9-8bb5-854a4738b3f0' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-449f50f4-63ae-43e9-8bb5-854a4738b3f0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-48c05638-70d7-4c0b-9e1b-4f5cc4d5f48d' class='xr-var-data-in' type='checkbox'><label for='data-48c05638-70d7-4c0b-9e1b-4f5cc4d5f48d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;01013500&#x27;, &#x27;01022500&#x27;, &#x27;01030500&#x27;, ..., &#x27;14325000&#x27;, &#x27;14362250&#x27;,
       &#x27;14400000&#x27;], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1980-01-01 ... 2014-12-31</div><input id='attrs-086a113d-d803-40f9-b862-422cba0f3535' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-086a113d-d803-40f9-b862-422cba0f3535' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5167e802-bc6f-493c-8c29-d4e50d5dea22' class='xr-var-data-in' type='checkbox'><label for='data-5167e802-bc6f-493c-8c29-d4e50d5dea22' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;1980-01-01T00:00:00.000000000&#x27;, &#x27;1980-01-02T00:00:00.000000000&#x27;,
       &#x27;1980-01-03T00:00:00.000000000&#x27;, ..., &#x27;2014-12-29T00:00:00.000000000&#x27;,
       &#x27;2014-12-30T00:00:00.000000000&#x27;, &#x27;2014-12-31T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-433333b9-d958-4b94-ac7d-63bbbff0da97' class='xr-section-summary-in' type='checkbox'  checked><label for='section-433333b9-d958-4b94-ac7d-63bbbff0da97' class='xr-section-summary' >Data variables: <span>(7)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>dayl</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-5b720d74-e06c-41e7-90e8-755871d288be' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-5b720d74-e06c-41e7-90e8-755871d288be' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-053e2a9a-03f1-4904-ad4f-4b42bf956e25' class='xr-var-data-in' type='checkbox'><label for='data-053e2a9a-03f1-4904-ad4f-4b42bf956e25' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>s</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>prcp</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-61ac4af5-5518-47e8-ac1c-67a29e5d74d4' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-61ac4af5-5518-47e8-ac1c-67a29e5d74d4' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f66bc22b-9299-4640-8aca-b31b19b3515a' class='xr-var-data-in' type='checkbox'><label for='data-f66bc22b-9299-4640-8aca-b31b19b3515a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>mm/day</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>srad</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-4eefce86-cf9f-457b-9b73-53b9b7ba2bf3' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-4eefce86-cf9f-457b-9b73-53b9b7ba2bf3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5b1cc819-c5b6-4a20-90d3-7f1ed944dc55' class='xr-var-data-in' type='checkbox'><label for='data-5b1cc819-c5b6-4a20-90d3-7f1ed944dc55' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>W/m2</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>swe</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-fc0e4c04-3686-4cfb-9649-5334a042070c' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-fc0e4c04-3686-4cfb-9649-5334a042070c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c79ac026-3b26-4fe0-8b60-90fba3d8a06d' class='xr-var-data-in' type='checkbox'><label for='data-c79ac026-3b26-4fe0-8b60-90fba3d8a06d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>mm</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>tmax</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-d9f9ab26-e5d3-4313-b0b7-062ff0815b01' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-d9f9ab26-e5d3-4313-b0b7-062ff0815b01' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-77b5613c-a8b4-4282-9145-55daf7cdf98b' class='xr-var-data-in' type='checkbox'><label for='data-77b5613c-a8b4-4282-9145-55daf7cdf98b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>C</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>tmin</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-4c47f04a-3481-4942-8632-46ce19aaaa2f' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-4c47f04a-3481-4942-8632-46ce19aaaa2f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c109d068-42bf-48cc-85ba-442f32b57f7b' class='xr-var-data-in' type='checkbox'><label for='data-c109d068-42bf-48cc-85ba-442f32b57f7b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>C</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>vp</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>...</div><input id='attrs-5946aa7d-1781-48d3-9232-f74e9b67d166' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-5946aa7d-1781-48d3-9232-f74e9b67d166' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-fe6c4525-2007-4ce7-b5d7-f91efb8bc8db' class='xr-var-data-in' type='checkbox'><label for='data-fe6c4525-2007-4ce7-b5d7-f91efb8bc8db' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>Pa</dd></dl></div><div class='xr-var-data'><pre>[8578064 values with dtype=float64]</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-d122cb35-1ece-45ae-aa20-1e8d9223d8f3' class='xr-section-summary-in' type='checkbox'  checked><label for='section-d122cb35-1ece-45ae-aa20-1e8d9223d8f3' class='xr-section-summary' >Attributes: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>forcing_type :</span></dt><dd>daymet</dd></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attrs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;camels_attributes_v2.0.feather&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attrs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gauge_id</th>
      <th>p_mean</th>
      <th>pet_mean</th>
      <th>p_seasonality</th>
      <th>frac_snow</th>
      <th>aridity</th>
      <th>high_prec_freq</th>
      <th>high_prec_dur</th>
      <th>high_prec_timing</th>
      <th>low_prec_freq</th>
      <th>...</th>
      <th>area_geospa_fabric</th>
      <th>frac_forest</th>
      <th>lai_max</th>
      <th>lai_diff</th>
      <th>gvf_max</th>
      <th>gvf_diff</th>
      <th>dom_land_cover_frac</th>
      <th>dom_land_cover</th>
      <th>root_depth_50</th>
      <th>root_depth_99</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01013500</td>
      <td>3.126679</td>
      <td>1.971555</td>
      <td>0.187940</td>
      <td>0.313440</td>
      <td>0.630559</td>
      <td>12.95</td>
      <td>1.348958</td>
      <td>son</td>
      <td>202.20</td>
      <td>...</td>
      <td>2303.95</td>
      <td>0.9063</td>
      <td>4.167304</td>
      <td>3.340732</td>
      <td>0.804567</td>
      <td>0.371648</td>
      <td>0.883452</td>
      <td>Mixed Forests</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01022500</td>
      <td>3.608126</td>
      <td>2.119256</td>
      <td>-0.114530</td>
      <td>0.245259</td>
      <td>0.587356</td>
      <td>20.55</td>
      <td>1.205279</td>
      <td>son</td>
      <td>233.65</td>
      <td>...</td>
      <td>620.38</td>
      <td>0.9232</td>
      <td>4.871392</td>
      <td>3.746692</td>
      <td>0.863936</td>
      <td>0.337712</td>
      <td>0.820493</td>
      <td>Mixed Forests</td>
      <td>0.237435</td>
      <td>2.238444</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01030500</td>
      <td>3.274405</td>
      <td>2.043594</td>
      <td>0.047358</td>
      <td>0.277018</td>
      <td>0.624111</td>
      <td>17.15</td>
      <td>1.207746</td>
      <td>son</td>
      <td>215.60</td>
      <td>...</td>
      <td>3676.09</td>
      <td>0.8782</td>
      <td>4.685200</td>
      <td>3.665543</td>
      <td>0.858502</td>
      <td>0.351393</td>
      <td>0.975258</td>
      <td>Mixed Forests</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>01031500</td>
      <td>3.522957</td>
      <td>2.071324</td>
      <td>0.104091</td>
      <td>0.291836</td>
      <td>0.587950</td>
      <td>18.90</td>
      <td>1.148936</td>
      <td>son</td>
      <td>227.35</td>
      <td>...</td>
      <td>766.53</td>
      <td>0.9548</td>
      <td>4.903259</td>
      <td>3.990843</td>
      <td>0.870668</td>
      <td>0.398619</td>
      <td>1.000000</td>
      <td>Mixed Forests</td>
      <td>0.250000</td>
      <td>2.400000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>01047000</td>
      <td>3.323146</td>
      <td>2.090024</td>
      <td>0.147776</td>
      <td>0.280118</td>
      <td>0.628929</td>
      <td>20.10</td>
      <td>1.165217</td>
      <td>son</td>
      <td>235.90</td>
      <td>...</td>
      <td>904.94</td>
      <td>0.9906</td>
      <td>5.086811</td>
      <td>4.300978</td>
      <td>0.891383</td>
      <td>0.445473</td>
      <td>0.850450</td>
      <td>Mixed Forests</td>
      <td>0.241027</td>
      <td>2.340180</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 60 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attrs</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;gauge_id&#39;, &#39;p_mean&#39;, &#39;pet_mean&#39;, &#39;p_seasonality&#39;, &#39;frac_snow&#39;,
       &#39;aridity&#39;, &#39;high_prec_freq&#39;, &#39;high_prec_dur&#39;, &#39;high_prec_timing&#39;,
       &#39;low_prec_freq&#39;, &#39;low_prec_dur&#39;, &#39;low_prec_timing&#39;, &#39;geol_1st_class&#39;,
       &#39;glim_1st_class_frac&#39;, &#39;geol_2nd_class&#39;, &#39;glim_2nd_class_frac&#39;,
       &#39;carbonate_rocks_frac&#39;, &#39;geol_porostiy&#39;, &#39;geol_permeability&#39;, &#39;q_mean&#39;,
       &#39;runoff_ratio&#39;, &#39;slope_fdc&#39;, &#39;baseflow_index&#39;, &#39;stream_elas&#39;, &#39;q5&#39;,
       &#39;q95&#39;, &#39;high_q_freq&#39;, &#39;high_q_dur&#39;, &#39;low_q_freq&#39;, &#39;low_q_dur&#39;,
       &#39;zero_q_freq&#39;, &#39;hfd_mean&#39;, &#39;huc_02&#39;, &#39;gauge_name&#39;,
       &#39;soil_depth_pelletier&#39;, &#39;soil_depth_statsgo&#39;, &#39;soil_porosity&#39;,
       &#39;soil_conductivity&#39;, &#39;max_water_content&#39;, &#39;sand_frac&#39;, &#39;silt_frac&#39;,
       &#39;clay_frac&#39;, &#39;water_frac&#39;, &#39;organic_frac&#39;, &#39;other_frac&#39;, &#39;gauge_lat&#39;,
       &#39;gauge_lon&#39;, &#39;elev_mean&#39;, &#39;slope_mean&#39;, &#39;area_gages2&#39;,
       &#39;area_geospa_fabric&#39;, &#39;frac_forest&#39;, &#39;lai_max&#39;, &#39;lai_diff&#39;, &#39;gvf_max&#39;,
       &#39;gvf_diff&#39;, &#39;dom_land_cover_frac&#39;, &#39;dom_land_cover&#39;, &#39;root_depth_50&#39;,
       &#39;root_depth_99&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="pytorchlstm-camels">
<h2>3 PyTorch实现LSTM-CAMELS<a class="headerlink" href="#pytorchlstm-camels" title="Permalink to this headline">#</a></h2>
<p>接下来，我们使用PyTorch来具体实现该模型，本节代码重点参考了：<a class="reference external" href="https://github.com/kratzert/pangeo_lstm_example/blob/master/LSTM_for_rainfall_runoff_modelling.ipynb">kratzert/pangeo_lstm_example</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 导入后续会用到的包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">hydrodataset.camels</span> <span class="kn">import</span> <span class="n">Camels</span>
<span class="kn">import</span> <span class="nn">HydroErr</span> <span class="k">as</span> <span class="nn">he</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 平台提供了GPU计算资源</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span>
    <span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<span class="p">)</span>  <span class="c1"># check if GPU is available</span>
</pre></div>
</div>
</div>
</div>
<section id="pytorch-datasetdataloadercamels">
<h3>3.1 用PyTorch Dataset与Dataloader组织CAMELS数据<a class="headerlink" href="#pytorch-datasetdataloadercamels" title="Permalink to this headline">#</a></h3>
<p>首先，构建读取CAMELS数据集数据的PyTorch Dataset和Dataloader.</p>
<p>模型训练时，会将样本分成一系列小批次（mini-batch），并使用随机梯度下降类算法完成各小批次的梯度下降计算。在计算机中执行运算时，每批次的输入数据会被组织成样本-时段-变量的三维数组，即tensor。其中，第一维的长度表示从总体样本中随机选择出的一部分样本的数目，即批次大小；第二维的长度表示LSTM的时序变量时段长度，训练中该长度是固定的；第三维代表各类型的输入变量。例如，数据集总流域数是100个，训练时间总长是1000天，变量共10种，一个批次时段长选择100天，则总样本数量就是100 *（1000-100+1），如果每个批次中包含从总样本中随机抽取的10个样本，那么每个样本就是数据量为100天*10个变量的二维张量，一个批次就是数据量为10*100*10的张量。</p>
<p>Dataset和DataLoader就是处理这些内容的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CamelsDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base data set class to load and preprocess data (batch-first) using PyTroch&#39;s Dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">basins</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">dates</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">data_attr</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">data_forcing</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">data_flow</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">loader_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span>
        <span class="n">seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">means</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Dataset containing the data of multiple basins.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basins : list</span>
<span class="sd">            _description_</span>
<span class="sd">        dates : list</span>
<span class="sd">            _description_</span>
<span class="sd">        data_attr : pd.DataFrame</span>
<span class="sd">            _description_</span>
<span class="sd">        data_forcing : xr.Dataset</span>
<span class="sd">            _description_</span>
<span class="sd">        data_flow : xr.Dataset</span>
<span class="sd">            _description_</span>
<span class="sd">        loader_type : str, optional</span>
<span class="sd">            _description_, by default &quot;train&quot;</span>
<span class="sd">        seq_length : int, optional</span>
<span class="sd">            _description_, by default 100</span>
<span class="sd">        means : pd.DataFrame, optional</span>
<span class="sd">            _description_, by default None</span>
<span class="sd">        stds : pd.DataFrame, optional</span>
<span class="sd">            _description_, by default None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CamelsDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">loader_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot; &#39;loader_type&#39; must be one of &#39;train&#39;, &#39;valid&#39; or &#39;test&#39; &quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loader_type</span> <span class="o">=</span> <span class="n">loader_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basins</span> <span class="o">=</span> <span class="n">basins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seq_length</span> <span class="o">=</span> <span class="n">seq_length</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">means</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="n">stds</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span> <span class="o">=</span> <span class="n">data_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_forcing</span> <span class="o">=</span> <span class="n">data_forcing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span> <span class="o">=</span> <span class="n">data_flow</span>

        <span class="c1"># load and preprocess data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">basin</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_table</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">seq_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_length</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                <span class="n">basin</span><span class="o">=</span><span class="n">basin</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">basin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="n">seq_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                <span class="n">basin</span><span class="o">=</span><span class="n">basin</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">time</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load data from nc and feather files&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_type</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="n">train_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">df_mean_forcings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_forcing</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">df_std_forcings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_forcing</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">df_mean_streamflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">df_std_streamflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">df_mean_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df_std_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_mean_forcings</span><span class="p">,</span> <span class="n">df_mean_attr</span><span class="p">,</span> <span class="n">df_mean_streamflow</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_std_forcings</span><span class="p">,</span> <span class="n">df_std_attr</span><span class="p">,</span> <span class="n">df_std_streamflow</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_mode</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># nomalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_normalization</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_forcing</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_forcing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_normalization</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">train_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_normalization</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="n">train_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_lookup_table</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_local_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Normalize features with local mean/std.&quot;&quot;&quot;</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">feature</span>

    <span class="k">def</span> <span class="nf">_create_lookup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create a index table for __getitem__ functions&quot;&quot;&quot;</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list to collect basins ids of basins without a single training sample</span>
        <span class="n">seq_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_length</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_flow</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">time_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">basin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">time_length</span> <span class="o">-</span> <span class="n">seq_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">lookup</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">basin</span><span class="p">,</span> <span class="n">dates</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_table</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookup</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_means</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>

    <span class="k">def</span> <span class="nf">get_stds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span>

    <span class="k">def</span> <span class="nf">local_denormalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;streamflow&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;revert the normalization for streaflow&quot;&quot;&quot;</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">feature</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>3.2 搭建LSTM模型<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h3>
<p>借助已有的神经网络模块，在PyTorch中实现一个深度学习模型是比较简单的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LSTM_CAMELS</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of a two-layer LSTM network&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct LSTM-CAMELS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_size : _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        hidden_size : int</span>
<span class="sd">            _description_</span>
<span class="sd">        dropout_rate : float, optional</span>
<span class="sd">            _description_, by default 0.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSTM_CAMELS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># create required layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span>
            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Forward pass through the Network&quot;&quot;&quot;</span>
        <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># perform prediction only at the end of the input sequence</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">pred</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id5">
<h2>4 训练模型<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h2>
<p>训练用的主函数</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train model for a single epoch&quot;&quot;&quot;</span>
    <span class="c1"># set model to train mode (important for dropout)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">notebook</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># request mini-batch of data from the loader</span>
    <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="c1"># delete previously stored gradients from the model</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># push data to GPU (if available)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">ys</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="c1"># get model predictions</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="c1"># calculate loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="c1"># calculate gradients</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="c1"># update the weights</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># write current loss in the progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>验证期和后面测试期使用的调用训练后模型计算的函数</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the model&quot;&quot;&quot;</span>
    <span class="c1"># set model to eval mode (important for dropout)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># in inference mode, we don&#39;t need to store intermediate steps for</span>
    <span class="c1"># backprob</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># request mini-batch of data from the loader</span>
        <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
            <span class="c1"># push data to GPU (if available)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="c1"># get model predictions</span>
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>这里我们选择100个流域来试一试模型的性能，就直接选择数据集中按id排序的前100个，总的训练时间长度用10年数据，1995-2005年，气象数据我们选择 dayl, prcp, srad, tmax, tmin 和 vp 6种，属性数据我们选择 ‘p_mean’, ‘p_seasonality’, ‘frac_snow’, ‘aridity’, ‘geol_porostiy’, ‘geol_permeability’， ‘soil_depth_statsgo’, ‘soil_porosity’, ‘soil_conductivity’, ‘elev_mean’, ‘slope_mean’, ‘area_gages2’,’frac_forest’, ‘lai_max’ 14种，当然你可以尝试别的变量组合。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_streamflow</span><span class="p">(</span><span class="n">ds_flow</span><span class="p">,</span> <span class="n">ds_attr</span><span class="p">,</span> <span class="n">basins</span><span class="p">,</span> <span class="n">time_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load streamflow data in the time_range and transform its unit from ft3/s to mm/day</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds_flow : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    ds_attr : _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    time_range : _type_</span>
<span class="sd">        _description_</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chosen_streamflow</span> <span class="o">=</span> <span class="n">ds_flow</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
        <span class="n">basin</span><span class="o">=</span><span class="n">basins</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">ds_attr</span><span class="p">[</span><span class="s2">&quot;area_gages2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.0283168</span>
        <span class="o">*</span> <span class="n">chosen_streamflow</span>
        <span class="o">*</span> <span class="mi">1000</span>
        <span class="o">*</span> <span class="mi">86400</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">area</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">flow</span>
</pre></div>
</div>
</div>
</div>
<p>为了结果能复现，我们设置固定的随机种子</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set a random seed to guarantee the reproducibility</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seed</span>
<span class="sd">        a number</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random seed:&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random seed: 1234
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basins_num</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">chosen_basins</span> <span class="o">=</span> <span class="n">camels_us</span><span class="o">.</span><span class="n">camels_sites</span><span class="p">[</span><span class="s2">&quot;gauge_id&quot;</span><span class="p">][:</span><span class="n">basins_num</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">train_times</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1990-09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-08-31&quot;</span><span class="p">]</span>
<span class="n">valid_times</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;2000-09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2005-08-31&quot;</span><span class="p">]</span>
<span class="n">chosen_forcing_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dayl&quot;</span><span class="p">,</span> <span class="s2">&quot;prcp&quot;</span><span class="p">,</span> <span class="s2">&quot;srad&quot;</span><span class="p">,</span> <span class="s2">&quot;tmax&quot;</span><span class="p">,</span> <span class="s2">&quot;tmin&quot;</span><span class="p">,</span> <span class="s2">&quot;vp&quot;</span><span class="p">]</span>
<span class="n">chosen_attrs_vars</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;p_mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;p_seasonality&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frac_snow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aridity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;geol_porostiy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;geol_permeability&quot;</span><span class="p">,</span>
    <span class="s2">&quot;soil_depth_statsgo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;soil_porosity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;soil_conductivity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;elev_mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;slope_mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;area_gages2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frac_forest&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lai_max&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 需要的属性</span>
<span class="n">chosen_attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;gauge_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">chosen_basins</span><span class="p">)][</span>
    <span class="p">[</span><span class="s2">&quot;gauge_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_attrs_vars</span>
<span class="p">]</span>
<span class="n">chosen_attrs</span> <span class="o">=</span> <span class="n">chosen_attrs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;gauge_id&quot;</span><span class="p">)</span>
<span class="n">chosen_attrs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_mean</th>
      <th>p_seasonality</th>
      <th>frac_snow</th>
      <th>aridity</th>
      <th>geol_porostiy</th>
      <th>geol_permeability</th>
      <th>soil_depth_statsgo</th>
      <th>soil_porosity</th>
      <th>soil_conductivity</th>
      <th>elev_mean</th>
      <th>slope_mean</th>
      <th>area_gages2</th>
      <th>frac_forest</th>
      <th>lai_max</th>
    </tr>
    <tr>
      <th>gauge_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>01013500</th>
      <td>3.126679</td>
      <td>0.18794</td>
      <td>0.313440</td>
      <td>0.630559</td>
      <td>0.1714</td>
      <td>-14.7019</td>
      <td>1.248408</td>
      <td>0.461149</td>
      <td>1.106522</td>
      <td>250.31</td>
      <td>21.64152</td>
      <td>2252.7</td>
      <td>0.9063</td>
      <td>4.167304</td>
    </tr>
    <tr>
      <th>01022500</th>
      <td>3.608126</td>
      <td>-0.11453</td>
      <td>0.245259</td>
      <td>0.587356</td>
      <td>0.0710</td>
      <td>-14.2138</td>
      <td>1.491846</td>
      <td>0.415905</td>
      <td>2.375005</td>
      <td>92.68</td>
      <td>17.79072</td>
      <td>573.6</td>
      <td>0.9232</td>
      <td>4.871392</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 需要的气象时序数据</span>
<span class="n">train_forcings</span> <span class="o">=</span> <span class="n">forcing_ds</span><span class="p">[</span><span class="n">chosen_forcing_vars</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">basin</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">train_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_times</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">valid_forcings</span> <span class="o">=</span> <span class="n">forcing_ds</span><span class="p">[</span><span class="n">chosen_forcing_vars</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">basin</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">valid_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_times</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 需要的径流数据</span>
<span class="c1"># NOTE： 这里把径流单位转换为 mm/day</span>
<span class="n">train_flow</span> <span class="o">=</span> <span class="n">load_streamflow</span><span class="p">(</span><span class="n">streamflow_ds</span><span class="p">,</span> <span class="n">chosen_attrs</span><span class="p">,</span> <span class="n">chosen_basins</span><span class="p">,</span> <span class="n">train_times</span><span class="p">)</span>
<span class="n">valid_flow</span> <span class="o">=</span> <span class="n">load_streamflow</span><span class="p">(</span><span class="n">streamflow_ds</span><span class="p">,</span> <span class="n">chosen_attrs</span><span class="p">,</span> <span class="n">chosen_basins</span><span class="p">,</span> <span class="n">valid_times</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_flow</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:     (basin: 2, time: 3653)
Coordinates:
  * basin       (basin) object &#x27;01013500&#x27; &#x27;01022500&#x27;
  * time        (time) datetime64[ns] 1990-09-01 1990-09-02 ... 2000-08-31
Data variables:
    streamflow  (basin, time) float64 0.3877 0.3703 0.3432 ... 0.2517 0.2431</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-3b4afd6d-dde2-498d-b2bf-70a48fdb7726' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-3b4afd6d-dde2-498d-b2bf-70a48fdb7726' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>basin</span>: 2</li><li><span class='xr-has-index'>time</span>: 3653</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-61d99726-a444-47ab-9cf1-596d76da9705' class='xr-section-summary-in' type='checkbox'  checked><label for='section-61d99726-a444-47ab-9cf1-596d76da9705' class='xr-section-summary' >Coordinates: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>basin</span></div><div class='xr-var-dims'>(basin)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;01013500&#x27; &#x27;01022500&#x27;</div><input id='attrs-fd459246-5a4d-460d-9c3d-e3fd39160485' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-fd459246-5a4d-460d-9c3d-e3fd39160485' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-55ed8afb-eb91-40fe-93bd-b5e9660f98e9' class='xr-var-data-in' type='checkbox'><label for='data-55ed8afb-eb91-40fe-93bd-b5e9660f98e9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;01013500&#x27;, &#x27;01022500&#x27;], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1990-09-01 ... 2000-08-31</div><input id='attrs-d56cab28-23a2-4c2b-a2ba-d039a84c5540' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d56cab28-23a2-4c2b-a2ba-d039a84c5540' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a76ee00b-e793-433d-87cb-5ea039e19ca5' class='xr-var-data-in' type='checkbox'><label for='data-a76ee00b-e793-433d-87cb-5ea039e19ca5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;1990-09-01T00:00:00.000000000&#x27;, &#x27;1990-09-02T00:00:00.000000000&#x27;,
       &#x27;1990-09-03T00:00:00.000000000&#x27;, ..., &#x27;2000-08-29T00:00:00.000000000&#x27;,
       &#x27;2000-08-30T00:00:00.000000000&#x27;, &#x27;2000-08-31T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-04e5b2cd-e9b9-4eb2-ad1c-41799549bed4' class='xr-section-summary-in' type='checkbox'  checked><label for='section-04e5b2cd-e9b9-4eb2-ad1c-41799549bed4' class='xr-section-summary' >Data variables: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>streamflow</span></div><div class='xr-var-dims'>(basin, time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.3877 0.3703 ... 0.2517 0.2431</div><input id='attrs-006e2b46-0e24-473a-883a-fa22d1c58297' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-006e2b46-0e24-473a-883a-fa22d1c58297' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-fc09813e-d13d-4779-a2fd-01025d8c7a21' class='xr-var-data-in' type='checkbox'><label for='data-fc09813e-d13d-4779-a2fd-01025d8c7a21' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[0.38772408, 0.37034709, 0.34319554, ..., 0.34319554, 0.33559311,
        0.32147431],
       [0.30710103, 0.29857044, 0.29430515, ..., 0.27724398, 0.25165223,
        0.24312165]])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-57ae0f8c-0905-45dc-a8c4-70695e3539ba' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-57ae0f8c-0905-45dc-a8c4-70695e3539ba' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># settings</span>
<span class="n">input_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_attrs_vars</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_forcing_vars</span><span class="p">)</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Number of LSTM cells</span>
<span class="n">dropout_rate</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Dropout rate of the final fully connected Layer [0.0, 1.0]</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># Learning rate used to update the weights</span>
<span class="n">sequence_length</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Length of the meteorological record provided to the network</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="c1"># Training data</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">CamelsDataset</span><span class="p">(</span>
    <span class="n">basins</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">train_times</span><span class="p">,</span>
    <span class="n">data_attr</span><span class="o">=</span><span class="n">chosen_attrs</span><span class="p">,</span>
    <span class="n">data_forcing</span><span class="o">=</span><span class="n">train_forcings</span><span class="p">,</span>
    <span class="n">data_flow</span><span class="o">=</span><span class="n">train_flow</span><span class="p">,</span>
    <span class="n">loader_type</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
    <span class="n">seq_length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span>
    <span class="n">means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tr_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Validation data</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">get_means</span><span class="p">()</span>
<span class="n">stds</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">get_stds</span><span class="p">()</span>
<span class="n">ds_val</span> <span class="o">=</span> <span class="n">CamelsDataset</span><span class="p">(</span>
    <span class="n">basins</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">valid_times</span><span class="p">,</span>
    <span class="n">data_attr</span><span class="o">=</span><span class="n">chosen_attrs</span><span class="p">,</span>
    <span class="n">data_forcing</span><span class="o">=</span><span class="n">valid_forcings</span><span class="p">,</span>
    <span class="n">data_flow</span><span class="o">=</span><span class="n">valid_flow</span><span class="p">,</span>
    <span class="n">loader_type</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
    <span class="n">seq_length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span>
    <span class="n">means</span><span class="o">=</span><span class="n">means</span><span class="p">,</span>
    <span class="n">stds</span><span class="o">=</span><span class="n">stds</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">valid_batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">valid_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Here we create our model, feel free</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LSTM_CAMELS</span><span class="p">(</span>
    <span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="n">dropout_rate</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>执行训练函数</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Number of training epochs</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
    <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">tr_loader</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">ds_val</span><span class="o">.</span><span class="n">local_denormalization</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;streamflow&quot;</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">basins_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">basins_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">he</span><span class="o">.</span><span class="n">nse</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">notebook</span><span class="o">.</span><span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation NSE mean: </span><span class="si">{</span><span class="n">nse</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "dad10e3b9c9f4f7a9a192727d9038a23", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Validation NSE mean: 0.58
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fd98e24738b74753b99cf505905ea4d9", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Validation NSE mean: 0.68
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h2>5 评价模型<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h2>
<p>最后，我们来看看如何评价模型</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate on test set</span>
<span class="n">test_times</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;2005-09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2010-08-31&quot;</span><span class="p">]</span>
<span class="n">test_forcings</span> <span class="o">=</span> <span class="n">forcing_ds</span><span class="p">[</span><span class="n">chosen_forcing_vars</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">basin</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">test_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_times</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">test_flow</span> <span class="o">=</span> <span class="n">load_streamflow</span><span class="p">(</span><span class="n">streamflow_ds</span><span class="p">,</span> <span class="n">chosen_attrs</span><span class="p">,</span> <span class="n">chosen_basins</span><span class="p">,</span> <span class="n">test_times</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">CamelsDataset</span><span class="p">(</span>
    <span class="n">basins</span><span class="o">=</span><span class="n">chosen_basins</span><span class="p">,</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">test_times</span><span class="p">,</span>
    <span class="n">data_attr</span><span class="o">=</span><span class="n">chosen_attrs</span><span class="p">,</span>
    <span class="n">data_forcing</span><span class="o">=</span><span class="n">test_forcings</span><span class="p">,</span>
    <span class="n">data_flow</span><span class="o">=</span><span class="n">test_flow</span><span class="p">,</span>
    <span class="n">loader_type</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">seq_length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span>
    <span class="n">means</span><span class="o">=</span><span class="n">means</span><span class="p">,</span>
    <span class="n">stds</span><span class="o">=</span><span class="n">stds</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">test_batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">test_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">obs</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">local_denormalization</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;streamflow&quot;</span><span class="p">)</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">basins_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">basins_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">nse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">he</span><span class="o">.</span><span class="n">nse</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
</pre></div>
</div>
</div>
</div>
<p>画图看看示例结果</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot results</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_test</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span>
    <span class="n">days</span><span class="o">=</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span>
<span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_test</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">basins_num</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observation&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basin </span><span class="si">{</span><span class="n">chosen_basins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - Test set NSE: </span><span class="si">{</span><span class="n">nse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Streamflow (mm/d)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/chp8.1_run_in_jupyter_47_0.png" src="../_images/chp8.1_run_in_jupyter_47_0.png" />
<img alt="../_images/chp8.1_run_in_jupyter_47_1.png" src="../_images/chp8.1_run_in_jupyter_47_1.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "tutorial"
        },
        kernelOptions: {
            kernelName: "tutorial",
            path: "./chp8_lstm_camels"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'tutorial'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="chp8.0_intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">使用CAMELS数据集构建基于LSTM的降雨径流模型</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="chp8.2_run_in_vscode.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">使用VSCode编写运行代码</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Wenyu Ouyang, Ziwen Meng, Xiaoning Liu, Xiangyi Le, Yaxin Lou, Jingyuan Huang<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>